name: Build and PR Binaries

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:

  build-msdf-atlas-gen-linux-arm64:
    name: msdf-atlas-gen (linux/arm64)
    runs-on: ubuntu-22.04-arm
    steps:
      - name: Install Build Dependencies (packages)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            ca-certificates \
            cmake \
            curl \
            git \
            ninja-build \
            pkg-config \
            python3 \
            tar \
            unzip \
            zip
      - name: Install Build Dependencies (vcpkg)
        run: |
          git clone https://github.com/microsoft/vcpkg ${{ runner.temp }}/vcpkg
          cd ${{ runner.temp }}/vcpkg
          ./bootstrap-vcpkg.sh
          echo "VCPKG_ROOT=${{ runner.temp }}/vcpkg" >> $GITHUB_ENV
      - name: Build msdf-atlas-gen
        run: |
          git clone --recurse-submodules https://github.com/Chlumsky/msdf-atlas-gen.git ${{ runner.temp }}/msdf-atlas-gen && \
          cd ${{ runner.temp }}/msdf-atlas-gen && \
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release && \
          cmake --build build
      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: msdf-atlas-gen-linux-arm64
          path: ${{ runner.temp }}/msdf-atlas-gen/build/bin/msdf-atlas-gen

  build-msdf-atlas-gen-linux-amd64:
    name: msdf-atlas-gen (linux/amd64)
    runs-on: ubuntu-22.04
    steps:
      - name: Install Build Dependencies (packages)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            ca-certificates \
            cmake \
            curl \
            git \
            ninja-build \
            pkg-config \
            python3 \
            tar \
            unzip \
            zip
      - name: Install Build Dependencies (vcpkg)
        run: |
          git clone https://github.com/microsoft/vcpkg ${{ runner.temp }}/vcpkg
          cd ${{ runner.temp }}/vcpkg
          ./bootstrap-vcpkg.sh
          echo "VCPKG_ROOT=${{ runner.temp }}/vcpkg" >> $GITHUB_ENV
      - name: Build msdf-atlas-gen
        run: |
          git clone --recurse-submodules https://github.com/Chlumsky/msdf-atlas-gen.git ${{ runner.temp }}/msdf-atlas-gen && \
          cd ${{ runner.temp }}/msdf-atlas-gen && \
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release && \
          cmake --build build
      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: msdf-atlas-gen-linux-amd64
          path: ${{ runner.temp }}/msdf-atlas-gen/build/bin/msdf-atlas-gen


  build-msdf-atlas-gen-darwin-arm64:
    name: msdf-atlas-gen (darwin/arm64)
    runs-on: macos-15
    steps:
      - name: Install Build Dependencies (packages)
        run: |
          brew install \
            cmake \
            ninja \
            pkgconf \
            python@3.14 \
            unzip \
            zip
      - name: Install Build Dependencies (vcpkg)
        run: |
          git clone https://github.com/microsoft/vcpkg ${{ runner.temp }}/vcpkg
          cd ${{ runner.temp }}/vcpkg
          ./bootstrap-vcpkg.sh
          echo "VCPKG_ROOT=${{ runner.temp }}/vcpkg" >> $GITHUB_ENV
      - name: Build msdf-atlas-gen
        run: |
          git clone --recurse-submodules https://github.com/Chlumsky/msdf-atlas-gen.git ${{ runner.temp }}/msdf-atlas-gen && \
          cd ${{ runner.temp }}/msdf-atlas-gen && \
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release && \
          cmake --build build
      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: msdf-atlas-gen-darwin-arm64
          path: ${{ runner.temp }}/msdf-atlas-gen/build/bin/msdf-atlas-gen

  build-msdf-atlas-gen-windows-amd64:
    name: msdf-atlas-gen (windows/amd64)
    runs-on: windows-2022
    steps:
      - name: Install Build Dependencies (packages)
        shell: pwsh
        run: |
          choco install -y --no-progress `
            cmake `
            ninja `
            git `
            pkgconfiglite `
            7zip
      - name: Install Build Dependencies (python)
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"
          architecture: "x64"
      - name: Install Build Dependencies (vcpkg)
        shell: pwsh
        run: |
          git clone https://github.com/microsoft/vcpkg "$env:RUNNER_TEMP\vcpkg"
          & "$env:RUNNER_TEMP\vcpkg\bootstrap-vcpkg.bat"
          "VCPKG_ROOT=$env:RUNNER_TEMP\vcpkg" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
      - name: Build msdf-atlas-gen
        shell: pwsh
        run: |
          git clone --recurse-submodules https://github.com/Chlumsky/msdf-atlas-gen.git "$env:RUNNER_TEMP\msdf-atlas-gen"
          cd "$env:RUNNER_TEMP\msdf-atlas-gen"
          cmake -S . -B build -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=x64-windows
          cmake --build build --config Release
      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: msdf-atlas-gen-windows-amd64
          path: |
            ${{ runner.temp }}\msdf-atlas-gen\build\bin\msdf-atlas-gen.exe
            ${{ runner.temp }}\msdf-atlas-gen\build\bin\Release\msdf-atlas-gen.exe
